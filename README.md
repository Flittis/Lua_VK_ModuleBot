# Lua_VK_ModuleBot
 
## Описание

Это **_модульный_ бот для VK** на Lua. 
Он отличается лёгкой масштабируемостью путем добавления в папку _**modules**_. 
Вы с лёгкостью можете отредактировать модули, написать свои, или же отключить готовые просто удаляя файл из папки

_Настройка бота_ осуществляется через файл _**config.lua**_, который автоматически генерируется в зависимости от установленных модулей

_Работоспособность  бота_ проверена на **Debian/Ubuntu**. 
На других ОС корректная работа не гарантируется

## Установка

  **Во-первых, нужно установить _[LUAJIT](https://luajit.org)_ и _[LuaRocks](https://luarocks.org/)_**

- **Если у вас уже установлен Lua5.3 и LuaRocks – нужно удалить:**
```
~# rm -rf /var/cache/luarocks /usr/local/include/lua.hpp /usr/local/include/lua.h /usr/local/etc/luarocks /usr/local/bin/luarocks-admin /usr/local/bin/luarocks /usr/local/bin/lua /usr/local/lib/luarocks /usr/local/lib/lua/5.3 /usr/local/share/lua
```

- **Устанавливаем инструменты для разработки:**
```
~# sudo apt update && sudo apt upgrade
~# sudo apt install build-essential libreadline-dev curl libcurl4 libcurl4-openssl-dev
~# sudo ln -s /usr/include/x86_64-linux-gnu/curl /usr/include/curl
```

- **Устанавливаем _LUAJIT_:**
```
~# git clone https://luajit.org/git/luajit-2.0.git
~# cd luajit-2.0
~# git checkout v2.1
~# sudo make install
~# ln -sf luajit-2.1.0-beta3 /usr/local/bin/luajit
```
- **Устанавливаем _LuaRocks_:**
```
~# wget https://luarocks.org/releases/luarocks-3.3.1.tar.gz
~# tar zxpf luarocks-3.3.1.tar.gz
~# cd luarocks-3.3.1
~# ./configure
~# make build
~# sudo make install
```

- **Устанавливаем библиотеки:**
```
~# luarocks install luautf8
~# luarocks install dkjson
```

- **После установки клонируем репозиторий:**
```
~# git clone https://github.com/Flittis/Lua_VK_ModuleBot.git
~# cd Lua_VK_ModuleBot
```

## Запуск бота
 - **Запустите скрипт (при первом запуске будет создан файл конфига с значениями по умолчанию)**
```
~# luajit index.lua   
[ERROR] Access token in config is not defined
```
После этого проверьте папку со скриптом на наличие _config.lua_.
 - **Для удобного управления и отслеживания работы скрипта можно
   использовать менеджер процессов PM2**
*Необходим установленный npm!*
```
~# sudo apt update && sudo apt install npm
~# npm install pm2 -g
```
 - **Добавляем скрипт в PM2**
```
~# pm2 start index.lua --name=LuaBot --interpreter=luajit
```
Подробно ознакомиться с функционалом пакетного менеджера, узнать как настроить автозапуск, смотреть логи и т.д. вы можете в официальной документации.
https://vk.cc/awUBaH

## Получаем токен

- **Перейдите по ссылке для получения токена с правами на сообщения:**
https://vkhost.github.io
*Для правильной работы бота в фантом-чатах рекомендуется получить токен от **VK Me***
*Токеном является часть после **access_token=**  до  **&expires_in***

- **Скопируйте ваш токен из адресной строки (никому его не показывайте)**
![alt text](https://github.com/Flittis/Lua_VK_ModuleBot/raw/master/tokenScreen.jpg)

## Настройка бота

Для настройки бота необходимо редактировать файл _**config.lua**_, 
Его объем зависит от количества установленных модулей

### Обозначения всех данных в конфиге:

- **Токен**
```
  accessToken = '<тут будет ваш токен>', -- это ваш токен, который вы указали в шаге выше
```

- **Удаление сообщений (_delmessages.lua_)**

Удаляет несколько ваших сообщений для **ВСЕХ ПОЛЬЗОВАТЕЛЕЙ** после отправки сообщения с указанным текстом

```
  deleteTrigger = 'ой',                  -- удаление предыдущих сообщений ("ой <количество>" если не указать количество - будет удалено только одно сообщение)
  deleteTriggerAll = '/delall',          -- удаление сообщений в промежутке последних 150-и сообщений в чат
  deleteEditTo = 'ᅠ',                     -- символ, на которое будет отредактировано сообщение, если указать минус после слова для удаления ("ой-", "ой-5"). Стандартно там установлен невидимый символ, то есть сообщение станет пустым перед удалением
```

- **Ответ стикером при написании ключевого слова в чатах (_trigger.lua_)**

Отправляет стикер, если кто-то в указанном чате отправит сообщение с указанным текстом

```
  stickerAddChat = '!chat',              -- добавление/удаление чата, в который было отправлено сообщение, в которых будет работать триггер стикером
  stickerAddSticker = '!sticker',        -- добавление/удаление стикеров, которые будут отправляться 
  stickerTriggerWords = {'пинг', 'тест'},-- слова через запятую, на которых будет реагировать бот
  stickerTriggerStickers = {1, 2, 3},    -- айди стикеров через запятую, которые будут отправляться
  stickerTriggerChats = {1, 2, 3},       -- чаты в которых бот будет работать
  stickerTriggerTime = 5,                -- таймаут между отправлениями стикеров
```

- **Розыгрыши (_giveaways.lua_)**

Запуск розыгрыша, в котором для участия нужно будет написать ключевое слово
После завершения, скрипт случайно выбирает победителя

```
  giveawayStartWord = '!розыгрыш',       -- текст сообщения, при котором будет начинатся розыгрыш ("!розыгрыш <время в минутах> <ключевое слово>" если не указывать время или ключевое слово – будут использовани стандартные значения)
  giveawayStop = '!stop',                -- текст сообщения, при котором розыгрыш будет немедленно окончен
  giveawayDefWord = 'Ку',                -- стандартное значения ключевого слова для розыгрыша
  giveawayDefTime = 5,                   -- стандартное значения времени в минутах для розыгрыша
  giveawayMinUsers = 1,                  -- минимальное количество участников в розыгрыше
```

- **Голосовые сообщения (_audiomessages.lua_)**

Отправка голосовых сообщений после отправки имени файла ("!_<название голосового>_" - отправит голосовое из папки _**/audios**_ с именем файла который вы указали)  
Пример:
  "_**!voice**_" - отправит голосовое _voice.ogg_

А также сохранение чужих голосовых сообщений ("!гс _<название голосового>_" – сохранит голосовое которое вы переслали с этим сообщением под именем которое вы указали)  
Пример:
  "_**!гс voice**_" – сохранит пересланное голосовое под именем _voice.ogg_ в папку _**/audios**_

```
  audioAdd = '!голосовое',                      -- текст сообщения, при котором пересланное голосовое сообщение будет сохранено в базу под указаным именем ("!гс тест" -> "!тест" отправит голосовое)
  audioReload = '!апдейтгс',             -- триггер, при котором будет обновляться база голосовых сообщений из папки /audios
```
_Для корректной работы файлы должны соответствовать требованиям: **sample rate 16kHz, variable bitrate 16 kbit/s, длительность не более 5 минут, моно.**_
_Конвертировать в такой формат вы можете здесь: **https://flts.cc/convertgit**_

- **Генератор смеха (_laugh.lua_)**

Просто генерирует смех из указанных символов, с указанной длиной

```
  laughTrigger = '!смех',                -- текст сообщения, при котором будет генерироваться смех
  laughtLength = {5, 20},                -- минимальная и максимальная длина генерируемого смеха через запятую
  laughLetters = {'А', 'Х', 'В'},        -- символы, из которых будет генерироваться смех
```

- **Логгер сообщений (_logger.lua_)**

Сохраняет историю сообщений из указанного чата, и отправляет по указанной команде

```
logAddChat = '!логчат',                  -- триггер, для включения логгера в чате, в который отправлено сообщение
logTrigger = '!лог',                     -- триггер, после которого будет отправлен лог чата
logChats = {1, 2, 3},                    -- айди чатов, в которых будет работать логгер
logMaxRecords = 15,                      -- максимальное количество записей в логгере на один чат
```

## Остались вопросы?

При наличии вопросов по работе бота можете написать мне в VK: https://vk.me/flittis
